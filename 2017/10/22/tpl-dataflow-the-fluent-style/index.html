<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      FluentDataflow - Fluent Style TPL Dataflow &middot; Teddy's Knowledge
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- Pretty Photo -->
  <script src="/public/js/jquery-1.6.1.min.js" type="text/javascript" charset="utf-8"></script>
  <link rel="stylesheet" href="/public/css/prettyPhoto.css" type="text/css" media="screen" charset="utf-8" />
  <script src="/public/js/jquery.prettyPhoto.js" type="text/javascript" charset="utf-8"></script>  
  
  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){
	  $("picture img").each(function(){
	    if (!$(this).attr('group')) return;
		
	    var parent = $(this).parent();
	    parent.attr('rel', 'prettyPhoto[group_' + $(this).attr('group') + ']');
		parent.attr('href', parent.children().first().attr('srcset'));
	  });
      $("picture[rel^='prettyPhoto']").prettyPhoto({theme:'pp_default',slideshow:5000,autoplay_slideshow:false,social_tools:false});
    });
  </script>
</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
	<p><center><img style="margin-right:10px;border-radius: 50%" src="//en.gravatar.com/userimage/97021725/fa8250da64cab70aa5d8430e92ac3c1a?size=80" /></center></p>
    <p>Teddy Ma, full-stack software developer/architect in internet & online education industry for 15 years @ Shanghai, China</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="http://teddyma.cnblogs.com">Teddy's Chinese Blog</a>
    <a class="sidebar-nav-item" href="/atom.xml">Subscribe</a>
    <a class="sidebar-nav-item" href="mailto:shijie.ma@gmail.com">Email</a>
	<a class="sidebar-nav-item" href="https://www.linkedin.com/in/teddyma">Profile</a>
    <a class="sidebar-nav-item" href="http://twitter.com/teddyma_cn">@teddyma_cn</a>
  </nav>
  <div class="sidebar-item">
	<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
		<input type="hidden" name="cmd" value="_donations">
		<input type="hidden" name="business" value="PUSNNK3485T6G">
		<input type="hidden" name="lc" value="US">
		<input type="hidden" name="item_name" value="Donate teddyma.cn">
		<!--<input type="hidden" name="amount" value="1.99">-->
		<input type="hidden" name="currency_code" value="USD">
		<input type="hidden" name="button_subtype" value="services">
		<input type="hidden" name="no_note" value="1">
		<input type="hidden" name="no_shipping" value="1">
		<input type="hidden" name="bn" value="PP-BuyNowBF:btn_buynow_SM.gif:NonHosted">
		<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
		<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
	</form>
  </div>
  <div class="sidebar-item">
    <p>
      &copy; 2018. All rights reserved.
    </p>
  </div>
  <div class="sidebar-item">
    <p>
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  if (ga) {
			ga('create', 'UA-72697830-1', 'auto');
			ga('send', 'pageview');
		  }
		</script>
    </p>
  </div> 
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Teddy's Knowledge</a>
            <small>.NET, Open Source, Cassandra, RabbitMQ, ELK, Docker, etc</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">FluentDataflow - Fluent Style TPL Dataflow</h1>
  <span class="post-date">22 Oct 2017&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/dataflow">dataflow</a>&nbsp;&nbsp;
	  
	
  </span>
  <p><strong>Background</strong></p>

<p>In modern application development, there are so many scenarios of dataflow processing, such large volume data processing, image/video conversion, data migration, etc.</p>

<p>In .NET, thanks to Microsoft for providing the TPL Dataflow library which is a flexible and high performance library for this area.</p>

<p>TPL dataflow is really flexible, but when we want to build complex dataflows, we might have to create bunch of blocks, manually wire them, be careful to avoid data blocking, write a lot of tricks even for implementing the simplest branching and merging cases. If you are ever a dataflow developer, do you remember how many times you ever wait for your dataflow to complete but it never happens and you have to debug line by line to find out where the message is blocked and why.</p>

<p>And for long time, I heard of developers complaining about its lack of a fluent style API which is kind of standard configuration for almost all JAVA world libraies and also already provided by many popular .NET libraries. So when I also experienced the same fustratings, I decide to build one, which is what I want to introduce here - <a href="https://github.com/teddymacn/FluentDataflow">FluentDataflow</a>.</p>

<p><strong>Introduction</strong></p>

<p><a href="https://github.com/teddymacn/FluentDataflow">FluentDataflow</a>, in short, is a fluent style wrapper and extension of TPL Dataflow.</p>

<p>The only entry-point of this library is the IDataflowFactory interface. Through the fluent style API provided by a factory instance, the outputs of this factory are still instances of standard IDataflowBlock, such as ITargetBlock, ISourceBlock, IPropogatorBlock, etc, instances, each of which usually wraps a simple or even a complex custom dataflow.</p>

<p>I heard what you are shouting: “Show me the code!” So, let’s go!</p>

<p><strong>Examples</strong></p>

<ul>
  <li>Simple aggregation example:</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">splitter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TransformBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;&gt;(</span><span class="n">input</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">string</span><span class="p">[]</span> <span class="n">splitted</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="sc">'='</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;(</span><span class="n">splitted</span><span class="p">[</span><span class="m">0</span><span class="p">],</span> <span class="kt">int</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">splitted</span><span class="p">[</span><span class="m">1</span><span class="p">]));</span>
<span class="p">});</span>

<span class="kt">var</span> <span class="n">dict</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;();</span>

<span class="kt">var</span> <span class="n">aggregater</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;&gt;(</span><span class="n">pair</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">oldValue</span><span class="p">;</span>
    <span class="n">dict</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">Key</span><span class="p">]</span> <span class="p">=</span> <span class="n">dict</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="k">out</span> <span class="n">oldValue</span><span class="p">)</span> <span class="p">?</span> <span class="n">oldValue</span> <span class="p">+</span> <span class="n">pair</span><span class="p">.</span><span class="n">Value</span> <span class="p">:</span> <span class="n">pair</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
<span class="p">});</span>

<span class="c1">// the created the dataflow instance is also</span>
<span class="c1">// a strong-typed standard dataflow block</span>
<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">().</span><span class="nf">FromPropagator</span><span class="p">(</span><span class="n">splitter</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">aggregater</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"a=1"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"b=2"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"a=5"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>

<span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"sum(a) = {0}"</span><span class="p">,</span> <span class="n">dict</span><span class="p">[</span><span class="s">"a"</span><span class="p">]);</span> <span class="c1">//prints sum(a) = 6</span>
</code></pre></div></div>

<ul>
  <li>A dataflow as part of another dataflow example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">factory</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">aggregater</span> <span class="p">=</span> <span class="p">...</span> <span class="c1">// Build an aggregator dataflow</span>
<span class="kt">var</span> <span class="n">splitter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TransformManyBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="n">line</span> <span class="p">=&gt;</span> <span class="n">line</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="sc">' '</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="n">factory</span><span class="p">.</span><span class="n">FromPropagator</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="n">splitter</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">aggregator</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"a=1 b=2 a=5"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"c=6 b=8"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>

<span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"sum(b) = {0}"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s">"b"</span><span class="p">]);</span> <span class="c1">//prints sum(b) = 10</span>
</code></pre></div></div>

<ul>
  <li>Broadcast example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">printer1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Printer1: {0}"</span><span class="p">,</span> <span class="n">s</span><span class="p">));</span>
<span class="kt">var</span> <span class="n">printer2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Printer2: {0}"</span><span class="p">,</span> <span class="n">s</span><span class="p">));</span>
<span class="kt">var</span> <span class="n">printer3</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Printer3: {0}"</span><span class="p">,</span> <span class="n">s</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">().</span><span class="n">FromBroadcast</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="nf">LinkTo</span><span class="p">(</span><span class="n">printer1</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkTo</span><span class="p">(</span><span class="n">printer2</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkTo</span><span class="p">(</span><span class="n">printer3</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"first message"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"second message"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"third message"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>Multiple sources example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// by default, with native TPL, if multiple sources link to the same target,</span>
<span class="c1">// if set PropagateCompletion=true,</span>
<span class="c1">// as long as one of the source complets, the target complets.</span>
<span class="c1">// the target will miss some of the messages from the other sources.</span>

<span class="c1">// BUT, with our dataflow factory here, when set PropagateCompletion=true,</span>
<span class="c1">// dataflow.Complete() internally waits for all the sources to complete,</span>
<span class="c1">// so the target is guaranteed to receive all the messages from all the sources</span>

<span class="kt">var</span> <span class="n">source1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">source2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">source3</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">printer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">().</span><span class="nf">FromMultipleSources</span><span class="p">(</span><span class="n">source1</span><span class="p">,</span> <span class="n">source2</span><span class="p">,</span> <span class="n">source3</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">printer</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
    <span class="n">source1</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">source2</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">source3</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>Linking with filter example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// the filter only accepts even numbers,</span>
<span class="c1">// so odd numbers goes to declined printer</span>
<span class="kt">var</span> <span class="n">filter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Predicate</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">i</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">i</span> <span class="p">%</span> <span class="m">2</span> <span class="p">==</span> <span class="m">0</span><span class="p">;</span>
<span class="p">});</span>
<span class="kt">var</span> <span class="n">printer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"printer: "</span> <span class="p">+</span> <span class="n">s</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()));</span>
<span class="kt">var</span> <span class="n">declinedPrinter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"declined: "</span> <span class="p">+</span> <span class="n">s</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()));</span>
<span class="kt">var</span> <span class="n">inputBlock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>

<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">().</span><span class="nf">FromPropagator</span><span class="p">(</span><span class="n">inputBlock</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">printer</span>
        <span class="p">,</span> <span class="n">filter</span>
        <span class="c1">// when linking with filter, you have to specify a declined block</span>
        <span class="c1">// otherwise, because there will be messages declined still in the queue,</span>
        <span class="c1">// the current block will not be able to COMPLETE (waits on its Completion will never return)</span>
        <span class="p">,</span> <span class="n">declinedPrinter</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>
</code></pre></div></div>
<ul>
  <li>Join example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">source1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">source2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">printer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"printer: {0},{1}"</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Item1</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Item2</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">().</span><span class="nf">Join</span><span class="p">(</span><span class="n">source1</span><span class="p">,</span> <span class="n">source2</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">printer</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
    <span class="n">source1</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">source2</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>Batch example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">source</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">printer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"printer: "</span> <span class="p">+</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">"|"</span><span class="p">,</span> <span class="n">s</span><span class="p">)));</span>

<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">().</span><span class="nf">FromSource</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Batch</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">printer</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">6</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
    <span class="n">source</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>
</code></pre></div></div>
<ul>
  <li>If-else branching and merging example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">factory</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">();</span>
<span class="c1">// the ifFilter only accepts even numbers,</span>
<span class="c1">// so odd numbers goes to elseBlock</span>
<span class="kt">var</span> <span class="n">ifFilter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Predicate</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">i</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">i</span> <span class="p">%</span> <span class="m">2</span> <span class="p">==</span> <span class="m">0</span><span class="p">;</span>
<span class="p">});</span>
<span class="kt">var</span> <span class="n">printer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"printer: "</span> <span class="p">+</span> <span class="n">s</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()));</span>
<span class="kt">var</span> <span class="n">inputBlock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>
<span class="c1">// if meet ifFilter, convert to: i -&gt; i * 10</span>
<span class="kt">var</span> <span class="n">ifBlock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TransformBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="n">i</span> <span class="p">*</span> <span class="m">10</span><span class="p">);</span>
<span class="c1">// else, convert to: i -&gt; i * 100</span>
<span class="kt">var</span> <span class="n">elseBlock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TransformBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="n">i</span> <span class="p">*</span> <span class="m">100</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">branchingDataflow</span> <span class="p">=</span> <span class="n">factory</span><span class="p">.</span><span class="nf">FromPropagator</span><span class="p">(</span><span class="n">inputBlock</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToPropagator</span><span class="p">(</span><span class="n">ifBlock</span><span class="p">,</span> <span class="n">ifFilter</span><span class="p">,</span> <span class="n">elseBlock</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">mergeingDataflow</span> <span class="p">=</span> <span class="n">factory</span><span class="p">.</span><span class="nf">FromMultipleSources</span><span class="p">(</span><span class="n">ifBlock</span><span class="p">,</span> <span class="n">elseBlock</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">printer</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="c1">//encapsulate branchingDataflow and mergeingDataflow</span>
<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="n">factory</span><span class="p">.</span><span class="nf">EncapsulateTargetDataflow</span><span class="p">(</span><span class="n">branchingDataflow</span><span class="p">,</span> <span class="n">mergeingDataflow</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>
</code></pre></div></div>

</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2018/08/09/machine-learning-in-action-study-notes/">
            Teddy's Machine Learning in Action Study Notes
            <small>09 Aug 2018</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/06/17/elasticsearch-lessons-learned/">
            Elasticsearch Mantanence Lessons Learned Today
            <small>17 Jun 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2016/02/23/rabbitmq-exchange-design-tradeoffs/">
            RabbitMQ Exchange and Queue Design Trade-off
            <small>23 Feb 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
    <br />
	<div id="disqus_thread"></div>
	<script>
		(function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
			var d = document, s = d.createElement('script');
			
			s.src = '//teddymacn.disqus.com/embed.js';  // IMPORTANT: Replace EXAMPLE with your forum shortname!
			
			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>  

</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
