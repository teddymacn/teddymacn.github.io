<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Teddy's Knowledge &middot; .NET, Open Source, Cassandra, RabbitMQ, ELK, Docker, etc
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- Pretty Photo -->
  <script src="/public/js/jquery-1.6.1.min.js" type="text/javascript" charset="utf-8"></script>
  <link rel="stylesheet" href="/public/css/prettyPhoto.css" type="text/css" media="screen" charset="utf-8" />
  <script src="/public/js/jquery.prettyPhoto.js" type="text/javascript" charset="utf-8"></script>  
  
  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){
	  $("picture img").each(function(){
	    if (!$(this).attr('group')) return;
		
	    var parent = $(this).parent();
	    parent.attr('rel', 'prettyPhoto[group_' + $(this).attr('group') + ']');
		parent.attr('href', parent.children().first().attr('srcset'));
	  });
      $("picture[rel^='prettyPhoto']").prettyPhoto({theme:'pp_default',slideshow:5000,autoplay_slideshow:false,social_tools:false});
    });
  </script>
</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
	<p><center><img style="margin-right:10px;border-radius: 50%" src="//en.gravatar.com/userimage/97021725/fa8250da64cab70aa5d8430e92ac3c1a?size=80" /></center></p>
    <p>Teddy Ma, full-stack software developer/architect in internet & online education industry for 15 years @ Shanghai, China</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="http://teddyma.cnblogs.com">Teddy's Chinese Blog</a>
    <a class="sidebar-nav-item" href="/atom.xml">Subscribe</a>
    <a class="sidebar-nav-item" href="mailto:shijie.ma@gmail.com">Email</a>
	<a class="sidebar-nav-item" href="https://www.linkedin.com/in/teddyma">Profile</a>
    <a class="sidebar-nav-item" href="http://twitter.com/teddyma_cn">@teddyma_cn</a>
  </nav>
  <div class="sidebar-item">
	<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
		<input type="hidden" name="cmd" value="_donations">
		<input type="hidden" name="business" value="PUSNNK3485T6G">
		<input type="hidden" name="lc" value="US">
		<input type="hidden" name="item_name" value="Donate teddyma.cn">
		<!--<input type="hidden" name="amount" value="1.99">-->
		<input type="hidden" name="currency_code" value="USD">
		<input type="hidden" name="button_subtype" value="services">
		<input type="hidden" name="no_note" value="1">
		<input type="hidden" name="no_shipping" value="1">
		<input type="hidden" name="bn" value="PP-BuyNowBF:btn_buynow_SM.gif:NonHosted">
		<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
		<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
	</form>
  </div>
  <div class="sidebar-item">
    <p>
      &copy; 2018. All rights reserved.
    </p>
  </div>
  <div class="sidebar-item">
    <p>
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  if (ga) {
			ga('create', 'UA-72697830-1', 'auto');
			ga('send', 'pageview');
		  }
		</script>
    </p>
  </div> 
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Teddy's Knowledge</a>
            <small>.NET, Open Source, Cassandra, RabbitMQ, ELK, Docker, etc</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/02/18/behind-rabbitmq-exchange-types/">
        Behind RabbitMQ Exchange Types
      </a>
    </h1>

    <span class="post-date">18 Feb 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/rabbitmq">rabbitmq</a>&nbsp;&nbsp;
	  
	
	</span>
    <p>Before touching RabbitMQ, I used MSMQ &amp; ZeroMQ much in real projects before. I also played  Apache ActiveMQ together with Camel a little bit (but not in real projects) when evaluating different ESB solutions before.</p>

<p>Like everyone, my first glance of RabbitMQ is the <a href="https://www.rabbitmq.com/getstarted.html">Get Started</a> tutorials, and the feeling of the RabbitMQ design philosophy is, it is quite like the design philosophy of ZeroMQ - simple &amp; consistent interface and super flexible configuration. Among all of the configuration options, the most interesting part is the “exchange types”. You might want to say that the concept of “exchange types” is from the <a href="https://www.rabbitmq.com/amqp-0-9-1-reference.html">AMQP</a> protocol, not invented by RabbitMQ. Yes, you are right. But no doubt that RabbitMQ is one of the most popular AMQP implementations.</p>

<p>The 6 examples in the <a href="https://www.rabbitmq.com/getstarted.html">Get Started</a> tutorials show the flexibility of RabbitMQ with the consistent and simple Publish &amp; Receive interface. And I believe you could already imagine many more usages of them to match many other common scenarios.</p>

<p>But, what’s the underlying philosophy behind “exchange types”? In a word, it is all about implementing integration patterns in a manner of simple, stupid.</p>

<p>If you ever played Apache ActiveMQ and Camel, you must be familar with the <a href="http://www.enterpriseintegrationpatterns.com">Enterprise Integration Patterns</a>. The examples of Apache Camel even exactly match all of the integration patterns. The design philosophy of ActiveMQ is, it provides the basic queue and pub/sub ability, and, together with Camel, to give ultimate flexibility for implementing all the integration patterns.</p>

<p>The design philosophy of ZeroMQ and RabbitMQ is quite different. Ultimate flexibility is cool, but performance and simplicity are also important. ZeroMQ chooses ultimate performance and simplicity rather than more integration features, while RabbitMQ is kind of in between of ActiveMQ and ZeroMQ. Its interface is as simple as ZeroMQ; the performance is not as super as ZeroMQ, but good enough; and it provides minimal but elegant configuration options to support most of the common integration patterns. One of the essences of its design is just the “exchange types”, which abstracts most common message routing &amp; consuming scenarios with only 5 easy-to-understand types: default (no routing), direct, fanout (broadcast), topic and header.</p>

<p>Modeling &amp; programming is the art of abstracting complexity. A real elegant design must be simple, stupid! That’s what behind the idea of “exchange types”.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/01/21/integrate-prettyphoto-with-jekyll-picture-tag/">
        Integrate PrettyPhoto with jekyll-picture-tag plugin
      </a>
    </h1>

    <span class="post-date">21 Jan 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/jekyll">jekyll</a>&nbsp;&nbsp;
	  
	
	</span>
    <p>In <a href="/2016/01/20/installed-jekyll-picture-tag/">previous post</a>, I talked about installed jekyll-picture-tag plugin to display pictures responsively in posts. It works very well in different browsers and resolutions. But sometimes, we might want a photo gallery. Instead of displaying the full size of photos, we might want to display thumbnails, and on click, popup a lightbox style slideshow window for displaying the full size of photos.</p>

<p>So, in this post, I want to talk about how I have integrated <a href="http://www.no-margin-for-errors.com/projects/prettyphoto-jquery-lightbox-clone/#prettyPhoto">PrettyPhoto</a> with jekyll-picture-tag plugin. Our goal is no change to jekyll-picture-tag plugin, and to use the same jekyll-picture-tag’s liquid tag format, only to add PrettyPhoto effect with addtional attributes when necessary.</p>

<p>The live example, is already in the <a href="/2016/01/20/installed-jekyll-picture-tag/">previous post</a>, an image is clicked, the PrettyPhoto slideshow window will popup.</p>

<p>The only addtional attribute we add to the jekyll-picture-tag liquid tag is “group”. You could see the sample liquid tag below. Images marked with the same group value, will be displayed together in the same PrettyPhoto slideshow window. So easy!</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{% picture 2015-1-20-1.jpg alt="picture 1" group="1" %}
{% picture 2015-1-20-2.jpg alt="picture 2" group="1" %}
</code></pre></div></div>

<p>Besides the addtional attribute in liquid tag. We also need to add necessary css and js to our page template. So, in the header include file, we need to add the following:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c">&lt;!-- Pretty Photo --&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/public/js/jquery-1.6.1.min.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/public/css/prettyPhoto.css"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">media=</span><span class="s">"screen"</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/public/js/jquery.prettyPhoto.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;&lt;/script&gt;</span>  
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
	  <span class="nx">$</span><span class="p">(</span><span class="s2">"picture img"</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'group'</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
		
	    <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">parent</span><span class="p">();</span>
	    <span class="nx">parent</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'rel'</span><span class="p">,</span> <span class="s1">'prettyPhoto[group_'</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'group'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">']'</span><span class="p">);</span>
		<span class="nx">parent</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'href'</span><span class="p">,</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">first</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'srcset'</span><span class="p">));</span>
	  <span class="p">});</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">"picture[rel^='prettyPhoto']"</span><span class="p">).</span><span class="nx">prettyPhoto</span><span class="p">({</span><span class="na">theme</span><span class="p">:</span><span class="s1">'pp_default'</span><span class="p">,</span><span class="na">slideshow</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="na">autoplay_slideshow</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="na">social_tools</span><span class="p">:</span><span class="kc">false</span><span class="p">});</span>
    <span class="p">});</span>
  <span class="nt">&lt;/script&gt;</span>  
</code></pre></div></div>

<p>Also, we need to add necessary css, js and image files to the jekyll repo. All the files could be downloaded from the official <a href="http://www.no-margin-for-errors.com/projects/prettyphoto-jquery-lightbox-clone/#prettyPhoto">PrettyPhoto</a> site.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/01/20/installed-jekyll-picture-tag/">
        Installed jekyll-picture-tag plugin
      </a>
    </h1>

    <span class="post-date">20 Jan 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/jekyll">jekyll</a>&nbsp;&nbsp;
	  
	
	</span>
    <p>Installed jekyll-picture-tag plugin to display pictures responsively in posts.</p>

<p>Steps to install:</p>

<p>Step 1: install gem;</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gem <span class="nb">install </span>jekyll-picture-tag
</code></pre></div></div>

<p>Step 2: edit _config.yml according to: <a href="https://github.com/robwierzbowski/jekyll-picture-tag/blob/master/examples/_config.yml">jekyll-picture-tag _config.yml example</a>;</p>

<p>Step 3: add liquid tag to post;</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{% picture 2015-1-20-1.jpg alt="picture 1" group="1" %}
{% picture 2015-1-20-2.jpg alt="picture 2" group="1" %}
</code></pre></div></div>

<picture>
    <source srcset="http://localhost:4000" media="" />
    <source srcset="http://localhost:4000" media="(min-width: 40em)" />
    <source srcset="http://localhost:4000" media="(min-width: 30em)" />
    <source srcset="http://localhost:4000" />
    <img src="http://localhost:4000" itemprop="image" alt="picture 1" group="1" />
  </picture>

<picture>
    <source srcset="http://localhost:4000" media="" />
    <source srcset="http://localhost:4000" media="(min-width: 40em)" />
    <source srcset="http://localhost:4000" media="(min-width: 30em)" />
    <source srcset="http://localhost:4000" />
    <img src="http://localhost:4000" itemprop="image" alt="picture 2" group="1" />
  </picture>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/01/19/how-to-change-rabbitmq-queue-parameters-in-production/">
        How to Change RabbitMQ Queue Parameters in Production?
      </a>
    </h1>

    <span class="post-date">19 Jan 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/rabbitmq">rabbitmq</a>&nbsp;&nbsp;
	  
	
	</span>
    <p><a href="http://www.rabbitmq.com/">RabbitMQ</a> does not allow re-declaring a queue with different values of parameters such as durability, auto delete, etc. Some parameters could be configured both by queue parameter and server-side policies, but if both are set, queue parameters win. So as long as queue parameters are used, it is the same problem.</p>

<p>So, what if, in production environment, we do want to do the change?</p>

<p><strong>Firstly</strong>, if your system could accept temporary downtime, then the easiest way is apparently to stop all your publisher and subscriber apps, delete the queue, and create the new one with new parameters.</p>

<p><strong>Secondly</strong>, if possible, instead of applying incompatible parameters on existing queue, it is always recommended to add a version number to your queue (meaning creating a new queue with the same name prefix as the old one, but to add/increase the version number as part of the queue name). So that after released the config or code and restarted all the publisher and consumer apps, you only need to move all the pending messages from the old queue (if any) to the new queue, and then delete the old queue.</p>

<p>If you really want to change some incompatible parameters of an existing queue in production environment in a safe way (no message lost and system hang), some tricky manual steps have to be executed. RabbitMQ is so flexible, you could have many different ways to reach the same goal, so here I just try to give some examples, from which, you could gain some clues to benefit your real scenarios.</p>

<p><strong>Example 1</strong>, if the dead letter exchange and the message TTL option of the old queue is not configured with queue parameters, meaning we could configure them with server-side policies, and also all the publisher apps only work with exchanges forwarding messages to the old queue, not publishing messages to the old queue directly:</p>

<ol>
  <li>We could temporarily create a new queue and a new exchange bound to it, set the temporary exchange as the dead letter exchange of the old queue and set the message TTL of the old queue to 0 with server-side policies. From now on, all the new messages published to the old queue will automatically be forwarded to the new queue.</li>
  <li>As long as the old queue have no pending messages any more, you could change the upstream exchanges of the old queue to bind to the new queue instead.</li>
  <li>Now you could recreate the old queue and repeat step 1 on the new queue (dead letter exchange and TTL 0) to change back to use the recreated queue.</li>
  <li>Delete all temporary exchanges and queues.</li>
</ol>

<p><strong>Example 2</strong>, similar to example 1, the difference is we could not configure dead letter exchange or message TTL on old queue, and if our subscribers could tolerate receiving duplicated messages:</p>

<ol>
  <li>We could create a temporary queue and bind to all the upstream exchanges of the old queue, so that duplicated messages are forwarded to both the old queue and the new queue now.</li>
  <li>Then we delete &amp; recreate the old queue with the same bindings.</li>
  <li>After restarted all the apps (they are still talking to the old queue), let’s move all the pending messages in the new queue to the old queue with the shovel plugin (please realize that there might be some duplicated messages received by subscribers).</li>
  <li>Delete the temporary queue.</li>
</ol>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/01/18/new-blog-site/">
        This is Teddy's New Blog!
      </a>
    </h1>

    <span class="post-date">18 Jan 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	
	</span>
    <p>Welcome to Teddy’s new blog site!</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page3">Older</a>
  
  
    
      <a class="pagination-item newer" href="/">Newer</a>
    
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
