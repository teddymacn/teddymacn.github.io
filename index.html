<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Teddy's Knowledge &middot; .NET, Open Source, Cassandra, RabbitMQ, ELK, Docker, etc
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- Pretty Photo -->
  <script src="/public/js/jquery-1.6.1.min.js" type="text/javascript" charset="utf-8"></script>
  <link rel="stylesheet" href="/public/css/prettyPhoto.css" type="text/css" media="screen" charset="utf-8" />
  <script src="/public/js/jquery.prettyPhoto.js" type="text/javascript" charset="utf-8"></script>  
  
  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){
	  $("picture img").each(function(){
	    if (!$(this).attr('group')) return;
		
	    var parent = $(this).parent();
	    parent.attr('rel', 'prettyPhoto[group_' + $(this).attr('group') + ']');
		parent.attr('href', parent.children().first().attr('srcset'));
	  });
      $("picture[rel^='prettyPhoto']").prettyPhoto({theme:'pp_default',slideshow:5000,autoplay_slideshow:false,social_tools:false});
    });
  </script>
</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
	<p><center><img style="margin-right:10px;border-radius: 50%" src="//en.gravatar.com/userimage/97021725/fa8250da64cab70aa5d8430e92ac3c1a?size=80" /></center></p>
    <p>Teddy Ma, full-stack software developer/architect in internet & online education industry for 15 years @ Shanghai, China</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="http://teddyma.cnblogs.com">Teddy's Chinese Blog</a>
    <a class="sidebar-nav-item" href="/atom.xml">Subscribe</a>
    <a class="sidebar-nav-item" href="mailto:shijie.ma@gmail.com">Email</a>
	<a class="sidebar-nav-item" href="https://www.linkedin.com/in/teddyma">Profile</a>
    <a class="sidebar-nav-item" href="http://twitter.com/teddyma_cn">@teddyma_cn</a>
  </nav>
  <div class="sidebar-item">
	<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
		<input type="hidden" name="cmd" value="_donations">
		<input type="hidden" name="business" value="PUSNNK3485T6G">
		<input type="hidden" name="lc" value="US">
		<input type="hidden" name="item_name" value="Donate teddyma.cn">
		<!--<input type="hidden" name="amount" value="1.99">-->
		<input type="hidden" name="currency_code" value="USD">
		<input type="hidden" name="button_subtype" value="services">
		<input type="hidden" name="no_note" value="1">
		<input type="hidden" name="no_shipping" value="1">
		<input type="hidden" name="bn" value="PP-BuyNowBF:btn_buynow_SM.gif:NonHosted">
		<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
		<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
	</form>
  </div>
  <div class="sidebar-item">
    <p>
      &copy; 2018. All rights reserved.
    </p>
  </div>
  <div class="sidebar-item">
    <p>
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  if (ga) {
			ga('create', 'UA-72697830-1', 'auto');
			ga('send', 'pageview');
		  }
		</script>
    </p>
  </div> 
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Teddy's Knowledge</a>
            <small>.NET, Open Source, Cassandra, RabbitMQ, ELK, Docker, etc</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2018/08/09/machine-learning-in-action-study-notes/">
        Teddy's Machine Learning in Action Study Notes
      </a>
    </h1>

    <span class="post-date">09 Aug 2018&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/machine-learning">machine learning</a>&nbsp;&nbsp;
	  
	
	</span>
    <p>In recent 3 months, I have spent most of my casual time in studying machine learning algorithms. I’m really a new comer to machine learning. And left college for more than 15 years, no surprise, I have successfully forgotten most of my maths knowledge for such as calculus, linear algebra, probabilities, statistics, etc.</p>

<p>How I began my learning was from reviewing all the maths by reading books, doing exercises, then watching online machine learning videos, and finally following books &amp; tutorials in action.</p>

<p>Next step I plan to work on some real practice projects. But before that, I collected my study notes of machine learning in action in a github repo.</p>

<p>Again, I’m still a freshman in machine learning, so I cannot 100% guarantee that all my understanding in the notes is correct though I have tried my best and hope it is. So if you find anything wrong in the repo, or if you have any comments or suggestions, please don’t hesitate to let me know.</p>

<p>Here is the link to my github repo:</p>

<p><a href="https://github.com/teddymacn/ml_in_action_study_notes">Teddy’s Machine Learning in Action Study Notes</a></p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/10/22/tpl-dataflow-the-fluent-style/">
        FluentDataflow - Fluent Style TPL Dataflow
      </a>
    </h1>

    <span class="post-date">22 Oct 2017&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/dataflow">dataflow</a>&nbsp;&nbsp;
	  
	
	</span>
    <p><strong>Background</strong></p>

<p>In modern application development, there are so many scenarios of dataflow processing, such large volume data processing, image/video conversion, data migration, etc.</p>

<p>In .NET, thanks to Microsoft for providing the TPL Dataflow library which is a flexible and high performance library for this area.</p>

<p>TPL dataflow is really flexible, but when we want to build complex dataflows, we might have to create bunch of blocks, manually wire them, be careful to avoid data blocking, write a lot of tricks even for implementing the simplest branching and merging cases. If you are ever a dataflow developer, do you remember how many times you ever wait for your dataflow to complete but it never happens and you have to debug line by line to find out where the message is blocked and why.</p>

<p>And for long time, I heard of developers complaining about its lack of a fluent style API which is kind of standard configuration for almost all JAVA world libraies and also already provided by many popular .NET libraries. So when I also experienced the same fustratings, I decide to build one, which is what I want to introduce here - <a href="https://github.com/teddymacn/FluentDataflow">FluentDataflow</a>.</p>

<p><strong>Introduction</strong></p>

<p><a href="https://github.com/teddymacn/FluentDataflow">FluentDataflow</a>, in short, is a fluent style wrapper and extension of TPL Dataflow.</p>

<p>The only entry-point of this library is the IDataflowFactory interface. Through the fluent style API provided by a factory instance, the outputs of this factory are still instances of standard IDataflowBlock, such as ITargetBlock, ISourceBlock, IPropogatorBlock, etc, instances, each of which usually wraps a simple or even a complex custom dataflow.</p>

<p>I heard what you are shouting: “Show me the code!” So, let’s go!</p>

<p><strong>Examples</strong></p>

<ul>
  <li>Simple aggregation example:</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">splitter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TransformBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;&gt;(</span><span class="n">input</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">string</span><span class="p">[]</span> <span class="n">splitted</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="sc">'='</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;(</span><span class="n">splitted</span><span class="p">[</span><span class="m">0</span><span class="p">],</span> <span class="kt">int</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">splitted</span><span class="p">[</span><span class="m">1</span><span class="p">]));</span>
<span class="p">});</span>

<span class="kt">var</span> <span class="n">dict</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;();</span>

<span class="kt">var</span> <span class="n">aggregater</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="n">KeyValuePair</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;&gt;(</span><span class="n">pair</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">oldValue</span><span class="p">;</span>
    <span class="n">dict</span><span class="p">[</span><span class="n">pair</span><span class="p">.</span><span class="n">Key</span><span class="p">]</span> <span class="p">=</span> <span class="n">dict</span><span class="p">.</span><span class="nf">TryGetValue</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">Key</span><span class="p">,</span> <span class="k">out</span> <span class="n">oldValue</span><span class="p">)</span> <span class="p">?</span> <span class="n">oldValue</span> <span class="p">+</span> <span class="n">pair</span><span class="p">.</span><span class="n">Value</span> <span class="p">:</span> <span class="n">pair</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
<span class="p">});</span>

<span class="c1">// the created the dataflow instance is also</span>
<span class="c1">// a strong-typed standard dataflow block</span>
<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">().</span><span class="nf">FromPropagator</span><span class="p">(</span><span class="n">splitter</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">aggregater</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"a=1"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"b=2"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"a=5"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>

<span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"sum(a) = {0}"</span><span class="p">,</span> <span class="n">dict</span><span class="p">[</span><span class="s">"a"</span><span class="p">]);</span> <span class="c1">//prints sum(a) = 6</span>
</code></pre></div></div>

<ul>
  <li>A dataflow as part of another dataflow example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">factory</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">aggregater</span> <span class="p">=</span> <span class="p">...</span> <span class="c1">// Build an aggregator dataflow</span>
<span class="kt">var</span> <span class="n">splitter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TransformManyBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="n">line</span> <span class="p">=&gt;</span> <span class="n">line</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="sc">' '</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="n">factory</span><span class="p">.</span><span class="n">FromPropagator</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;(</span><span class="n">splitter</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">aggregator</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"a=1 b=2 a=5"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"c=6 b=8"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>

<span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"sum(b) = {0}"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s">"b"</span><span class="p">]);</span> <span class="c1">//prints sum(b) = 10</span>
</code></pre></div></div>

<ul>
  <li>Broadcast example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">printer1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Printer1: {0}"</span><span class="p">,</span> <span class="n">s</span><span class="p">));</span>
<span class="kt">var</span> <span class="n">printer2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Printer2: {0}"</span><span class="p">,</span> <span class="n">s</span><span class="p">));</span>
<span class="kt">var</span> <span class="n">printer3</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Printer3: {0}"</span><span class="p">,</span> <span class="n">s</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">().</span><span class="n">FromBroadcast</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()</span>
    <span class="p">.</span><span class="nf">LinkTo</span><span class="p">(</span><span class="n">printer1</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkTo</span><span class="p">(</span><span class="n">printer2</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkTo</span><span class="p">(</span><span class="n">printer3</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"first message"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"second message"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="s">"third message"</span><span class="p">);</span>
<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>Multiple sources example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// by default, with native TPL, if multiple sources link to the same target,</span>
<span class="c1">// if set PropagateCompletion=true,</span>
<span class="c1">// as long as one of the source complets, the target complets.</span>
<span class="c1">// the target will miss some of the messages from the other sources.</span>

<span class="c1">// BUT, with our dataflow factory here, when set PropagateCompletion=true,</span>
<span class="c1">// dataflow.Complete() internally waits for all the sources to complete,</span>
<span class="c1">// so the target is guaranteed to receive all the messages from all the sources</span>

<span class="kt">var</span> <span class="n">source1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">source2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">source3</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">printer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">().</span><span class="nf">FromMultipleSources</span><span class="p">(</span><span class="n">source1</span><span class="p">,</span> <span class="n">source2</span><span class="p">,</span> <span class="n">source3</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">printer</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
    <span class="n">source1</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">source2</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">source3</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>Linking with filter example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// the filter only accepts even numbers,</span>
<span class="c1">// so odd numbers goes to declined printer</span>
<span class="kt">var</span> <span class="n">filter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Predicate</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">i</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">i</span> <span class="p">%</span> <span class="m">2</span> <span class="p">==</span> <span class="m">0</span><span class="p">;</span>
<span class="p">});</span>
<span class="kt">var</span> <span class="n">printer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"printer: "</span> <span class="p">+</span> <span class="n">s</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()));</span>
<span class="kt">var</span> <span class="n">declinedPrinter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"declined: "</span> <span class="p">+</span> <span class="n">s</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()));</span>
<span class="kt">var</span> <span class="n">inputBlock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>

<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">().</span><span class="nf">FromPropagator</span><span class="p">(</span><span class="n">inputBlock</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">printer</span>
        <span class="p">,</span> <span class="n">filter</span>
        <span class="c1">// when linking with filter, you have to specify a declined block</span>
        <span class="c1">// otherwise, because there will be messages declined still in the queue,</span>
        <span class="c1">// the current block will not be able to COMPLETE (waits on its Completion will never return)</span>
        <span class="p">,</span> <span class="n">declinedPrinter</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>
</code></pre></div></div>
<ul>
  <li>Join example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">source1</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">source2</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">printer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"printer: {0},{1}"</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Item1</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">Item2</span><span class="p">));</span>

<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">().</span><span class="nf">Join</span><span class="p">(</span><span class="n">source1</span><span class="p">,</span> <span class="n">source2</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">printer</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">3</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
    <span class="n">source1</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">source2</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>Batch example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">source</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">printer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"printer: "</span> <span class="p">+</span><span class="kt">string</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">"|"</span><span class="p">,</span> <span class="n">s</span><span class="p">)));</span>

<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">().</span><span class="nf">FromSource</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Batch</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">printer</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">var</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">6</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">s</span> <span class="p">=</span> <span class="n">i</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
    <span class="n">source</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>
</code></pre></div></div>
<ul>
  <li>If-else branching and merging example</li>
</ul>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">factory</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DataflowFactory</span><span class="p">();</span>
<span class="c1">// the ifFilter only accepts even numbers,</span>
<span class="c1">// so odd numbers goes to elseBlock</span>
<span class="kt">var</span> <span class="n">ifFilter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Predicate</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">i</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">i</span> <span class="p">%</span> <span class="m">2</span> <span class="p">==</span> <span class="m">0</span><span class="p">;</span>
<span class="p">});</span>
<span class="kt">var</span> <span class="n">printer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ActionBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"printer: "</span> <span class="p">+</span> <span class="n">s</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()));</span>
<span class="kt">var</span> <span class="n">inputBlock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BufferBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>
<span class="c1">// if meet ifFilter, convert to: i -&gt; i * 10</span>
<span class="kt">var</span> <span class="n">ifBlock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TransformBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="n">i</span> <span class="p">*</span> <span class="m">10</span><span class="p">);</span>
<span class="c1">// else, convert to: i -&gt; i * 100</span>
<span class="kt">var</span> <span class="n">elseBlock</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TransformBlock</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;(</span><span class="n">i</span> <span class="p">=&gt;</span> <span class="n">i</span> <span class="p">*</span> <span class="m">100</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">branchingDataflow</span> <span class="p">=</span> <span class="n">factory</span><span class="p">.</span><span class="nf">FromPropagator</span><span class="p">(</span><span class="n">inputBlock</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToPropagator</span><span class="p">(</span><span class="n">ifBlock</span><span class="p">,</span> <span class="n">ifFilter</span><span class="p">,</span> <span class="n">elseBlock</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="kt">var</span> <span class="n">mergeingDataflow</span> <span class="p">=</span> <span class="n">factory</span><span class="p">.</span><span class="nf">FromMultipleSources</span><span class="p">(</span><span class="n">ifBlock</span><span class="p">,</span> <span class="n">elseBlock</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">LinkToTarget</span><span class="p">(</span><span class="n">printer</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

<span class="c1">//encapsulate branchingDataflow and mergeingDataflow</span>
<span class="kt">var</span> <span class="n">dataflow</span> <span class="p">=</span> <span class="n">factory</span><span class="p">.</span><span class="nf">EncapsulateTargetDataflow</span><span class="p">(</span><span class="n">branchingDataflow</span><span class="p">,</span> <span class="n">mergeingDataflow</span><span class="p">);</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">10</span><span class="p">;</span> <span class="p">++</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">dataflow</span><span class="p">.</span><span class="nf">Post</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">dataflow</span><span class="p">.</span><span class="nf">Complete</span><span class="p">();</span>

<span class="n">Task</span><span class="p">.</span><span class="nf">WaitAll</span><span class="p">(</span><span class="n">dataflow</span><span class="p">.</span><span class="n">Completion</span><span class="p">);</span>
</code></pre></div></div>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/06/17/elasticsearch-lessons-learned/">
        Elasticsearch Mantanence Lessons Learned Today
      </a>
    </h1>

    <span class="post-date">17 Jun 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/elasticsearch">elasticsearch</a>&nbsp;&nbsp;
	  
	    <a href="/tag/logstash">logstash</a>&nbsp;&nbsp;
	  
	    <a href="/tag/kibana">kibana</a>&nbsp;&nbsp;
	  
	
	</span>
    <p><strong>The elasticsearch cluster was down!</strong></p>

<p>Today I troubleshooted an Elasticsearch-cluster-down issue. We have a 3-node Elasticsearch cluster receiving hundreds of Giga of tracking data every day. And this afternoon, it was suddenly down and all our kibana dashboards failed to load any data from it.</p>

<p>From <a href="https://github.com/lmenezes/elasticsearch-kopf">elasticsearch-kopf</a> monitor, we could see more than half of the shards are unallocated, so it sounds like at least 2 nodes were just restarted for some reason. Coz of our cluster setting is each index has one primary and one replica, until at least the primary shards are allocated, the indices are not able to be loaded. The shards are being slowly allocated automatically. If I’m patient enough and just wait for a while, it should be recover by itself in my understanding. So I try to wait. After 10 minutes, some dashboards could display, which looks good. But after 30 minutes, from kopf, I could see the HEAP of the master node keeps increasing, and eventually full. And the entire cluster becomes no responsive again. Restart the master node, but the HEAP still keeps increasing and be full and cluster down again.</p>

<p><strong>Is it because the shards being reallocated too slow?</strong></p>

<p>Someone in my team is working one a kibana dashboard, and since it suddenly stopped working, he reached me and asked if I could help to do something to speed up the recovery. And I’m guessing. Is it because the shards were reallocated too slow? I have a script which calls the elasticsearch API to do force shard reallocation. When I created the script, it was for fixing very few shards which could not be reallocated by elasticsearch itself. It looks like below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">IFS</span><span class="o">=</span><span class="s1">$'</span><span class="se">\n</span><span class="s1">'</span>
<span class="k">for </span>line <span class="k">in</span> <span class="k">$(</span>curl <span class="nt">-s</span> <span class="s1">'server_name/es/_cat/shards'</span> | fgrep UNASSIGNED<span class="k">)</span><span class="p">;</span> <span class="k">do
  </span><span class="nv">INDEX</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> | <span class="o">(</span><span class="nb">awk</span> <span class="s1">'{print $1}'</span><span class="k">)</span><span class="o">)</span>
  <span class="nv">SHARD</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$line</span> | <span class="o">(</span><span class="nb">awk</span> <span class="s1">'{print $2}'</span><span class="k">)</span><span class="o">)</span>

  curl <span class="nt">-XPOST</span> <span class="s1">'server_name/es/_cluster/reroute'</span> <span class="nt">-d</span> <span class="s1">'{
     "commands": [
        {
            "allocate": {
                "index": "'</span><span class="nv">$INDEX</span><span class="s1">'",
                "shard": '</span><span class="nv">$SHARD</span><span class="s1">',
                "node": "ETELASTIC1",
                "allow_primary": true
          }
        }
    ]
  }'</span>

  <span class="c"># try again since the first try might fail if the target node already has a copy of the shard</span>
  curl <span class="nt">-XPOST</span> <span class="s1">'server_name/es/_cluster/reroute'</span> <span class="nt">-d</span> <span class="s1">'{
     "commands": [
        {
            "allocate": {
                "index": "'</span><span class="nv">$INDEX</span><span class="s1">'",
                "shard": '</span><span class="nv">$SHARD</span><span class="s1">',
                "node": "ETELASTIC2",
                "allow_primary": true
          }
        }
    ]
  }'</span>

  <span class="nb">sleep </span>2

<span class="k">done</span>
</code></pre></div></div>

<p>Restarted the master node and executed the script, and it keeps running. It’ll take some time coz I have 10K of unallocated shards. The reallocation becomes faster. But no luck that before it finishes, the HEAP became full again. So sounds like the guess is not correct.</p>

<p><strong>What causes the HEAP increasing then?</strong></p>

<p>Checked the log of elasticsearch, and it shows there are only very few small cheap reads during the cluster down &amp; recovery time. Checked the nodes breaker API and the fielddata cache is also not big. So what else might cost elasticsearch memory? If not reads, then it might be writes?</p>

<p>Luckily we have centralized logstash server for parsing all different types of tracking logs and feeding them to elasticsearch servers, so I simply stopped all of them. Restarted the master node again, wait and eventually, the elasticsearch cluster recovered without HEAP issue. Great! Here it is. So it should be because we configured our logstash jobs to always try re-connect elasticsearch servers when server connection timeout or no response, and since we have many logstash jobs trying to reconnect, it costs too much elasticsearch server-side memory in HEAP.</p>

<p>Let’s try some kibana dashboards, WAIT! Why some of the dashboards returns 404? It is impossible that people deleted them during my troubleshooting, we rarely delete dashboards. It makes me nerves. Coz it looks like reallocation of elasticsearch shards might cause data loss. WTF! If that’s true, how could we truct elasticsearch anymore?</p>

<p><strong>Always human’s fault!</strong></p>

<p>Ok, ask google. And, found the reason. Usually, it is always human’s fault. I mean, my fault, not elasticsearch’s. It is because of the <a href="https://discuss.elastic.co/t/cluster-reroute-and-potential-data-loss/15573">“allow_primary=true”</a> option in my “force reallocation” script. Bascially, when all the shards of an index are unallocated yet, and if you do reroute with the “allow_primary=true” option, some shards might become empty, and you LOSS data! Luckily, it is some shards of the kibana metadata index were lost, so I realized this issue, if it is only some tracking index loss, it is much harder for me to be awared.</p>

<p>But I’m lucky enough, coz:</p>

<ol>
  <li>I have daily backup of the kibana metadata index with <a href="https://github.com/taskrabbit/elasticsearch-dump">elasticdump</a>, and no much dashboard changes everyday;</li>
  <li>We keeps latest 3-day raw data of all the tracking logs, so I could easily re-index them;</li>
</ol>

<p>Restored from the kibana metadata index backup. And finally, all the dashboards are back!</p>

<p><strong>Summary</strong></p>

<p>Several lessons were learned here:</p>

<ol>
  <li>When many elasticsearch cluster nodes are restarted, to avoid HEAP spike, better to temporarily stop all connection attempts;</li>
  <li>Avoid setting allow_primary=true when reroute shards via API;</li>
  <li>Don’t forget backup! It could save you some day!</li>
</ol>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/02/23/rabbitmq-exchange-design-tradeoffs/">
        RabbitMQ Exchange and Queue Design Trade-off
      </a>
    </h1>

    <span class="post-date">23 Feb 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/rabbitmq">rabbitmq</a>&nbsp;&nbsp;
	  
	
	</span>
    <p>In <a href="/2016/02/22/understanding-rabbitmq-exchange-and-queue/">previous post</a>, I mentioned the <a href="http://stackoverflow.com/questions/32220312/rabbitmq-amqp-best-practise-queue-topic-design-in-a-microservice-architecture">discussion</a> on StackOverflow regarding designing exchanges. Usually, when people ask about best practice of designing exchanges, you will get some useful suggestions, but finally you will be told that the final solution always “depends on your system needs”. Fair enough &amp; safe enough answer, but not really helpful enough. So I want to extend this discussion a little bit here with more detailed backgrounds.</p>

<p>Before discussing any solutions, I’m trying to suggest some rules first. No matter which solutions to choose, these rules should be correct in most cases and should be followed if there are no compelling reasons.</p>

<p><strong>Rule 1</strong>
Each queue should only represent one type of jobs. Do not mix different type of messages in one queue. And when this rule is followed, we could clearly name a queue with the job represented by it.</p>

<p><strong>Rule 2</strong>
Avoid messgae re-dispatching on a queue. If you find that your subscriber is trying to re-dispatch any messages to other places without real processing, there might be something wrong. Routing or dispatching is the responsibility of exchanges rather than queues.</p>

<p><strong>Rule 3</strong>
When not using the global default exchange, publishers should know nothing about queues. One of the essences of the AMQP design is the responsibility separation of exchange &amp; queue, so that publishers don’t need to care about message comsuption, and comcumers don’t need tocare about where comes the messages at all. So when designing exchanges, the concepts only related to publishing, such as routing keys &amp; message headers, should not has any knowledge of the queues they will finally been forwarded to.</p>

<p>Now let’s focus on the examples. The scenario is that you want to design exchanges and queues for “user” related write events. The write events will be triggered in one or many apps and these messages are to be consumed by some other apps.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| object | event   |
|------------------|
| user   | created |
| user   | updated |
| user   | deleted |
</code></pre></div></div>

<p>The first question people usually ask is for different events of one object (the “user” object in this example), should we use one exchange for publishing all the 3 events, or use 3 separate exchanges for each event? Or, in short, one exchange, or many?</p>

<p>Before answering this question. I actually want to ask another question: do we really even need a custom exchange for this case?</p>

<p>Different types of object events are so natual to match different types of messages to be published, but it is not really necessary sometimes. What if we abstract all the 3 types of events as a “write” event, whose sub-types are “created”, “updated” and “deleted”?</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| object | event   | sub-type |
|-----------------------------|
| user   | write   | created  |
| user   | write   | updated  |
| user   | write   | deleted  |
</code></pre></div></div>

<p><strong>Solution 1</strong>
The simplest solution to support this is we could only design a “user.write” queue, and publish all user write event messages to this queue directly via the global default exchange. When publishing to a queue directly, the biggest limitation is it assumes that only one app subscribes to this type of messages. Multiple instances of one app subscribing to this queue is also fine.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| queue      | app  |
|-------------------|
| user.write | app1 |
</code></pre></div></div>

<p><strong>Solution 2</strong>
The simplest solution could not work when there is a second app (having different processing logic) want to subscribe to any messages published to the queue. When there are multiple apps subscribing, we at least need one “fanout” type exchange with bindings to multiple queues. So that messages are published to the excahnge, and the exchange duplicates the messages to each of the queues. Each queue represents the processing job of each different app.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| queue           | subscriber  |
|-------------------------------|
| user.write.app1 | app1        |
| user.write.app2 | app2        |

| exchange   | type   | binding_queue   |
|---------------------------------------|
| user.write | fanout | user.write.app1 |
| user.write | fanout | user.write.app2 |
</code></pre></div></div>

<p>This second solution works fine if each subscriber does care about and want to handle all the sub-types of “user.write” events or at least to expose all these sub-type events to each subscribers is not a problem. For instance, if the subscriber app is for simply keeping the transction log; or although the subscriber handles only user.created, it is ok to let it know about when user.updated or user.deleted happens. It becomes less elegant when some subscribers are from external of your organization, and you only want to notify them about some specific sub-type events. For instance, if app2 only wants to handle user.created and it should not have the knowledge of user.updated or user.deleted at all.</p>

<p><strong>Solution 3</strong>
To solve the issue above, we have to extract “user.created” concept from “user.write”. The “topic” type of exchange could help. When publishing the messages, let’s use user.created/user.updated/user.deleted as routing keys, so that we could set the binding key of “user.write.app1” queue be “user.*” and the binding key of “user.created.app2” queue be “user.created”.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| queue             | subscriber  |
|---------------------------------|
| user.write.app1   | app1        |
| user.created.app2 | app2        |

| exchange   | type  | binding_queue     | binding_key  |
|-------------------------------------------------------|
| user.write | topic | user.write.app1   | user.*       |
| user.write | topic | user.created.app2 | user.created |
</code></pre></div></div>

<p><strong>Solution 4</strong>
The “topic” exchange type is more flexible in case potentially there will be more event sub-types. But if you clearly know the exact number of events, you could also use the “direct” exchange type instead for better performance.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| queue             | subscriber  |
|---------------------------------|
| user.write.app1   | app1        |
| user.created.app2 | app2        |

| exchange   | type   | binding_queue    | binding_key   |
|--------------------------------------------------------|
| user.write | direct | user.write.app1   | user.created |
| user.write | direct | user.write.app1   | user.updated |
| user.write | direct | user.write.app1   | user.deleted |
| user.write | direct | user.created.app2 | user.created |
</code></pre></div></div>

<p>Come back to the “one exchange, or many?” question. So far, all the solutions use only one exchange. Works fine, nothing wrong. Then, when might we need multiple exchanges? <a href="http://spring.io/blog/2011/04/01/routing-topologies-for-performance-and-scalability-with-rabbitmq/">This link</a> summarizes some valuable ideas about performance and scalability considerations. If performance difference of too many bindings on “topic exchange” really becomes an issue, of course you could use more “direct” exchanges to reduce number of “topic” exchange bindings for better performance. But, here I want to focus more on function limitations of “one exchange” solutions.</p>

<p><strong>Solution 5</strong>
One case we might natually consider multiple exchanges is for different groups or dimensions of events. For instance, besides the created, updated and deleted events memtioned above, if we have another group of events: login and logout - a group of events describing “user behaviors” rather than “data write”. Coz different group of events might need completely different routing strategies and routing key &amp; queue naming conventions, it is so that natual to have a separate user.behavior exchange.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>| queue              | subscriber  |
|----------------------------------|
| user.write.app1    | app1        |
| user.created.app2  | app2        |
| user.behavior.app3 | app3        |

| exchange      | type  | binding_queue      | binding_key     |
|--------------------------------------------------------------|
| user.write    | topic | user.write.app1    | user.*          |
| user.write    | topic | user.created.app2  | user.created    |
| user.behavior | topic | user.behavior.app3 | user.*          |
</code></pre></div></div>

<p><strong>Other Solutions</strong>
There are other cases when we might need multiple exchanges for one object type. For instance, if you want to set different permissions on exchanges (e.g. only selected events of one object type are allowed to be published to one exchange from external apps, while the other exchange accepts any the events from internal apps). For another instance, if you want to use different exchanges suffixed with a version number to support different versions of routing strategies of same group of events. For another another instance, you might want to define some “internal exchanges” for exchange-to-exchange bindings, which could manage routing rules in a layered way.</p>

<p>In summary, still, “the final solution depends on your system needs”, but with all the solution examples above, and with the background considerations, as said in the <a href="http://spring.io/blog/2011/04/01/routing-topologies-for-performance-and-scalability-with-rabbitmq/">performance and scalability consideration link</a>, I also hope it could at least get one thinking in the right directions.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/02/22/understanding-rabbitmq-exchange-and-queue/">
        Understanding RabbitMQ Exchange and Queue
      </a>
    </h1>

    <span class="post-date">22 Feb 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/rabbitmq">rabbitmq</a>&nbsp;&nbsp;
	  
	
	</span>
    <p>In <a href="/2016/02/18/behind-rabbitmq-exchange-types/">previous post</a>, I compared the difference of ActiveMQ (JMS) and RabbitMQ (AMQP)’s design philosophy. RabbitMQ has its beauty of simplicity in its design with 5 exchange types. In this post, I want to clarify the understanding of RabbitMQ’s exchange &amp; queue and their relationship - binding.</p>

<p>In brief, exchanges are the only places where messages could be published to; while queues are the only places where messages could be consumed from. And the configurations for how messages should be routed from exchanges to queues are called bindings.</p>

<p>Imagine a message as a mail, then an exchange is like a post office, and a queue is kind of a mailbox in front of someone’s house. Different exchange types are like different types of mails which will be delivered in different ways. For instances, if a school wants to send the same notification mail to every student’s mailbox (kind of broardcast), it is exchange type - “fanout”; if a mail should only be sent to one specific student’s mailbox, it is exchange type - “direct”, and the key of the binding between the exchange and the queue should be the address of the student’s mailbox which the post office could understand. The mail to be sent to the post office should have the same address written on it, this address is the “routing key” of the message.</p>

<p>In RabbitMQ, it is not possible for a publisher to send a message to a queue directly. Even when you send a message without specifying an exchange, the message is actually sent to the global default exchange, who has bindings to each queue with queue name as binding key.</p>

<p>Messages can only be consumed from queues, consuming from exchanges directly are not allowed. An exchange has no storage. So if you send a message to an exchange while there are no queues bound to it or no bindings match the routing key of the message, the message will be thrown away immediately.</p>

<p>About designing exchanges, there is <a href="http://stackoverflow.com/questions/32220312/rabbitmq-amqp-best-practise-queue-topic-design-in-a-microservice-architecture">an interesting discussion</a> on StackOverflow for modeling a classic scenario. One exchange, or many? Which one is better? My opinion is similar to derick’s. It really depends on your system needs. RabbitMQ’s exchange types are simple, but flexible enough to support different modellings for the same scenario. There are always tradeoffs with each one. But no matter one or many exchanges you choose, I agree with Jason Lotito’s comments there about routing keys and naming convention of queues: “Routing keys are elements of the message, and the queues shouldn’t care about that (he means the naming of queues should not care about value of routing keys of published messages). That’s what bindings are for.”, “Queue names should be named after what the consumer attached to the queue will do. What is the intent of the operation of this queue.”.</p>

  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
