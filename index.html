<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Teddy's Knowledge &middot; .NET, Open Source, Cassandra, RabbitMQ, ELK, Architecture, etc
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- Pretty Photo -->
  <script src="/public/js/jquery-1.6.1.min.js" type="text/javascript" charset="utf-8"></script>
  <link rel="stylesheet" href="/public/css/prettyPhoto.css" type="text/css" media="screen" charset="utf-8" />
  <script src="/public/js/jquery.prettyPhoto.js" type="text/javascript" charset="utf-8"></script>  
  
  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){
	  $("picture img").each(function(){
	    if (!$(this).attr('group')) return;
		
	    var parent = $(this).parent();
	    parent.attr('rel', 'prettyPhoto[group_' + $(this).attr('group') + ']');
		parent.attr('href', parent.children().first().attr('srcset'));
	  });
      $("picture[rel^='prettyPhoto']").prettyPhoto({theme:'pp_default',slideshow:5000,autoplay_slideshow:false,social_tools:false});
    });
  </script>
</head>


  <body class="sidebar-overlay">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
	<p><center><img style="margin-right:10px;border-radius: 50%" src="http://en.gravatar.com/userimage/97021725/fa8250da64cab70aa5d8430e92ac3c1a?size=80" /></center></p>
    <p>Teddy Ma, full-stack software developer/architect in internet & online education industry for 15 years @ Shanghai, China</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
    
      
        
      
    

    <a class="sidebar-nav-item" href="http://teddyma.cnblogs.com">Teddy's Chinese Blog</a>
    <a class="sidebar-nav-item" href="/atom.xml">Subscribe</a>
    <a class="sidebar-nav-item" href="mailto:shijie.ma@gmail.com">Email</a>
	<a class="sidebar-nav-item" href="https://www.linkedin.com/in/teddyma">Profile</a>
    <a class="sidebar-nav-item" href="http://twitter.com/teddyma_cn">@teddyma_cn</a>
  </nav>
  <div class="sidebar-item">
	<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
		<input type="hidden" name="cmd" value="_donations">
		<input type="hidden" name="business" value="PUSNNK3485T6G">
		<input type="hidden" name="lc" value="US">
		<input type="hidden" name="item_name" value="Donate teddyma.cn">
		<!--<input type="hidden" name="amount" value="1.99">-->
		<input type="hidden" name="currency_code" value="USD">
		<input type="hidden" name="button_subtype" value="services">
		<input type="hidden" name="no_note" value="1">
		<input type="hidden" name="no_shipping" value="1">
		<input type="hidden" name="bn" value="PP-BuyNowBF:btn_buynow_SM.gif:NonHosted">
		<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
		<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">
	</form>
  </div>
  <div class="sidebar-item">
    <p>
      &copy; 2016. All rights reserved.
    </p>
  </div>
  <div class="sidebar-item">
    <p>
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  if (ga) {
			ga('create', 'UA-72697830-1', 'auto');
			ga('send', 'pageview');
		  }
		</script>
    </p>
  </div> 
</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Teddy's Knowledge</a>
            <small>.NET, Open Source, Cassandra, RabbitMQ, ELK, Architecture, etc</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/06/17/elasticsearch-lessons-learned/">
        Elasticsearch Mantanence Lessons Learned Today
      </a>
    </h1>

    <span class="post-date">17 Jun 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/elasticsearch">elasticsearch</a>&nbsp;&nbsp;
	  
	    <a href="/tag/logstash">logstash</a>&nbsp;&nbsp;
	  
	    <a href="/tag/kibana">kibana</a>&nbsp;&nbsp;
	  
	
	</span>
    <p><strong>The elasticsearch cluster was down!</strong></p>

<p>Today I troubleshooted an Elasticsearch-cluster-down issue. We have a 3-node Elasticsearch cluster receiving hundreds of Giga of tracking data every day. And this afternoon, it was suddenly down and all our kibana dashboards failed to load any data from it.</p>

<p>From <a href="https://github.com/lmenezes/elasticsearch-kopf">elasticsearch-kopf</a> monitor, we could see more than half of the shards are unallocated, so it sounds like at least 2 nodes were just restarted for some reason. Coz of our cluster setting is each index has one primary and one replica, until at least the primary shards are allocated, the indices are not able to be loaded. The shards are being slowly allocated automatically. If I’m patient enough and just wait for a while, it should be recover by itself in my understanding. So I try to wait. After 10 minutes, some dashboards could display, which looks good. But after 30 minutes, from kopf, I could see the HEAP of the master node keeps increasing, and eventually full. And the entire cluster becomes no responsive again. Restart the master node, but the HEAP still keeps increasing and be full and cluster down again.</p>

<p><strong>Is it because the shards being reallocated too slow?</strong></p>

<p>Someone in my team is working one a kibana dashboard, and since it suddenly stopped working, he reached me and asked if I could help to do something to speed up the recovery. And I’m guessing. Is it because the shards were reallocated too slow? I have a script which calls the elasticsearch API to do force shard reallocation. When I created the script, it was for fixing very few shards which could not be reallocated by elasticsearch itself. It looks like below:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nv">IFS</span><span class="o">=</span><span class="nv">$'</span><span class="se">\n</span><span class="s1">'
for line in $(curl -s '</span>server_name/es/_cat/shards<span class="s1">' | fgrep UNASSIGNED); do
  INDEX=$(echo $line | (awk '</span><span class="o">{</span>print <span class="nv">$1</span><span class="o">}</span><span class="s1">'))
  SHARD=$(echo $line | (awk '</span><span class="o">{</span>print <span class="nv">$2</span><span class="o">}</span><span class="s1">'))

  curl -XPOST '</span>server_name/es/_cluster/reroute<span class="s1">' -d '</span><span class="o">{</span>
     <span class="s2">"commands"</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">"allocate"</span>: <span class="o">{</span>
                <span class="s2">"index"</span>: <span class="s2">"'</span><span class="nv">$INDEX</span><span class="s2">'"</span>,
                <span class="s2">"shard"</span>: <span class="s1">'$SHARD'</span>,
                <span class="s2">"node"</span>: <span class="s2">"ETELASTIC1"</span>,
                <span class="s2">"allow_primary"</span>: <span class="nb">true</span>
          <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">]</span>
  <span class="o">}</span><span class="s1">'

  # try again since the first try might fail if the target node already has a copy of the shard
  curl -XPOST '</span>server_name/es/_cluster/reroute<span class="s1">' -d '</span><span class="o">{</span>
     <span class="s2">"commands"</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">"allocate"</span>: <span class="o">{</span>
                <span class="s2">"index"</span>: <span class="s2">"'</span><span class="nv">$INDEX</span><span class="s2">'"</span>,
                <span class="s2">"shard"</span>: <span class="s1">'$SHARD'</span>,
                <span class="s2">"node"</span>: <span class="s2">"ETELASTIC2"</span>,
                <span class="s2">"allow_primary"</span>: <span class="nb">true</span>
          <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">]</span>
  <span class="o">}</span><span class="s1">'

  sleep 2

done
</span></code></pre>
</div>

<p>Restarted the master node and executed the script, and it keeps running. It’ll take some time coz I have 10K of unallocated shards. The reallocation becomes faster. But no luck that before it finishes, the HEAP became full again. So sounds like the guess is not correct.</p>

<p><strong>What causes the HEAP increasing then?</strong></p>

<p>Checked the log of elasticsearch, and it shows there are only very few small cheap reads during the cluster down &amp; recovery time. Checked the nodes breaker API and the fielddata cache is also not big. So what else might cost elasticsearch memory? If not reads, then it might be writes?</p>

<p>Luckily we have centralized logstash server for parsing all different types of tracking logs and feeding them to elasticsearch servers, so I simply stopped all of them. Restarted the master node again, wait and eventually, the elasticsearch cluster recovered without HEAP issue. Great! Here it is. So it should be because we configured our logstash jobs to always try re-connect elasticsearch servers when server connection timeout or no response, and since we have many logstash jobs trying to reconnect, it costs too much elasticsearch server-side memory in HEAP.</p>

<p>Let’s try some kibana dashboards, WAIT! Why some of the dashboards returns 404? It is impossible that people deleted them during my troubleshooting, we rarely delete dashboards. It makes me nerves. Coz it looks like reallocation of elasticsearch shards might cause data loss. WTF! If that’s true, how could we truct elasticsearch anymore?</p>

<p><strong>Always human’s fault!</strong></p>

<p>Ok, ask google. And, found the reason. Usually, it is always human’s fault. I mean, my fault, not elasticsearch’s. It is because of the <a href="https://discuss.elastic.co/t/cluster-reroute-and-potential-data-loss/15573">“allow_primary=true”</a> option in my “force reallocation” script. Bascially, when all the shards of an index are unallocated yet, and if you do reroute with the “allow_primary=true” option, some shards might become empty, and you LOSS data! Luckily, it is some shards of the kibana metadata index were lost, so I realized this issue, if it is only some tracking index loss, it is much harder for me to be awared.</p>

<p>But I’m lucky enough, coz:</p>

<ol>
  <li>I have daily backup of the kibana metadata index with <a href="https://github.com/taskrabbit/elasticsearch-dump">elasticdump</a>, and no much dashboard changes everyday;</li>
  <li>We keeps latest 3-day raw data of all the tracking logs, so I could easily re-index them;</li>
</ol>

<p>Restored from the kibana metadata index backup. And finally, all the dashboards are back!</p>

<p><strong>Summary</strong></p>

<p>Several lessons were learned here:</p>

<ol>
  <li>When many elasticsearch cluster nodes are restarted, to avoid HEAP spike, better to temporarily stop all connection attempts;</li>
  <li>Avoid setting allow_primary=true when reroute shards via API;</li>
  <li>Don’t forget backup! It could save you some day!</li>
</ol>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/02/23/rabbitmq-exchange-design-tradeoffs/">
        RabbitMQ Exchange and Queue Design Trade-off
      </a>
    </h1>

    <span class="post-date">23 Feb 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/rabbitmq">rabbitmq</a>&nbsp;&nbsp;
	  
	
	</span>
    <p>In <a href="/2016/02/22/understanding-rabbitmq-exchange-and-queue/">previous post</a>, I mentioned the <a href="http://stackoverflow.com/questions/32220312/rabbitmq-amqp-best-practise-queue-topic-design-in-a-microservice-architecture">discussion</a> on StackOverflow regarding designing exchanges. Usually, when people ask about best practice of designing exchanges, you will get some useful suggestions, but finally you will be told that the final solution always “depends on your system needs”. Fair enough &amp; safe enough answer, but not really helpful enough. So I want to extend this discussion a little bit here with more detailed backgrounds.</p>

<p>Before discussing any solutions, I’m trying to suggest some rules first. No matter which solutions to choose, these rules should be correct in most cases and should be followed if there are no compelling reasons.</p>

<p><strong>Rule 1</strong><br />
Each queue should only represent one type of jobs. Do not mix different type of messages in one queue. And when this rule is followed, we could clearly name a queue with the job represented by it.</p>

<p><strong>Rule 2</strong><br />
Avoid messgae re-dispatching on a queue. If you find that your subscriber is trying to re-dispatch any messages to other places without real processing, there might be something wrong. Routing or dispatching is the responsibility of exchanges rather than queues.</p>

<p><strong>Rule 3</strong><br />
When not using the global default exchange, publishers should know nothing about queues. One of the essences of the AMQP design is the responsibility separation of exchange &amp; queue, so that publishers don’t need to care about message comsuption, and comcumers don’t need tocare about where comes the messages at all. So when designing exchanges, the concepts only related to publishing, such as routing keys &amp; message headers, should not has any knowledge of the queues they will finally been forwarded to.</p>

<p>Now let’s focus on the examples. The scenario is that you want to design exchanges and queues for “user” related write events. The write events will be triggered in one or many apps and these messages are to be consumed by some other apps.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>| object | event   |
|------------------|
| user   | created |
| user   | updated |
| user   | deleted |
</code></pre>
</div>

<p>The first question people usually ask is for different events of one object (the “user” object in this example), should we use one exchange for publishing all the 3 events, or use 3 separate exchanges for each event? Or, in short, one exchange, or many?</p>

<p>Before answering this question. I actually want to ask another question: do we really even need a custom exchange for this case?</p>

<p>Different types of object events are so natual to match different types of messages to be published, but it is not really necessary sometimes. What if we abstract all the 3 types of events as a “write” event, whose sub-types are “created”, “updated” and “deleted”?</p>

<div class="highlighter-rouge"><pre class="highlight"><code>| object | event   | sub-type |
|-----------------------------|
| user   | write   | created  |
| user   | write   | updated  |
| user   | write   | deleted  |
</code></pre>
</div>

<p><strong>Solution 1</strong><br />
The simplest solution to support this is we could only design a “user.write” queue, and publish all user write event messages to this queue directly via the global default exchange. When publishing to a queue directly, the biggest limitation is it assumes that only one app subscribes to this type of messages. Multiple instances of one app subscribing to this queue is also fine.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>| queue      | app  |
|-------------------|
| user.write | app1 |
</code></pre>
</div>

<p><strong>Solution 2</strong><br />
The simplest solution could not work when there is a second app (having different processing logic) want to subscribe to any messages published to the queue. When there are multiple apps subscribing, we at least need one “fanout” type exchange with bindings to multiple queues. So that messages are published to the excahnge, and the exchange duplicates the messages to each of the queues. Each queue represents the processing job of each different app.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>| queue           | subscriber  |
|-------------------------------|
| user.write.app1 | app1        |
| user.write.app2 | app2        |

| exchange   | type   | binding_queue   |
|---------------------------------------|
| user.write | fanout | user.write.app1 |
| user.write | fanout | user.write.app2 |
</code></pre>
</div>

<p>This second solution works fine if each subscriber does care about and want to handle all the sub-types of “user.write” events or at least to expose all these sub-type events to each subscribers is not a problem. For instance, if the subscriber app is for simply keeping the transction log; or although the subscriber handles only user.created, it is ok to let it know about when user.updated or user.deleted happens. It becomes less elegant when some subscribers are from external of your organization, and you only want to notify them about some specific sub-type events. For instance, if app2 only wants to handle user.created and it should not have the knowledge of user.updated or user.deleted at all.</p>

<p><strong>Solution 3</strong><br />
To solve the issue above, we have to extract “user.created” concept from “user.write”. The “topic” type of exchange could help. When publishing the messages, let’s use user.created/user.updated/user.deleted as routing keys, so that we could set the binding key of “user.write.app1” queue be “user.*” and the binding key of “user.created.app2” queue be “user.created”.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>| queue             | subscriber  |
|---------------------------------|
| user.write.app1   | app1        |
| user.created.app2 | app2        |

| exchange   | type  | binding_queue     | binding_key  |
|-------------------------------------------------------|
| user.write | topic | user.write.app1   | user.*       |
| user.write | topic | user.created.app2 | user.created |
</code></pre>
</div>

<p><strong>Solution 4</strong><br />
The “topic” exchange type is more flexible in case potentially there will be more event sub-types. But if you clearly know the exact number of events, you could also use the “direct” exchange type instead for better performance.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>| queue             | subscriber  |
|---------------------------------|
| user.write.app1   | app1        |
| user.created.app2 | app2        |

| exchange   | type   | binding_queue    | binding_key   |
|--------------------------------------------------------|
| user.write | direct | user.write.app1   | user.created |
| user.write | direct | user.write.app1   | user.updated |
| user.write | direct | user.write.app1   | user.deleted |
| user.write | direct | user.created.app2 | user.created |
</code></pre>
</div>

<p>Come back to the “one exchange, or many?” question. So far, all the solutions use only one exchange. Works fine, nothing wrong. Then, when might we need multiple exchanges? <a href="http://spring.io/blog/2011/04/01/routing-topologies-for-performance-and-scalability-with-rabbitmq/">This link</a> summarizes some valuable ideas about performance and scalability considerations. If performance difference of too many bindings on “topic exchange” really becomes an issue, of course you could use more “direct” exchanges to reduce number of “topic” exchange bindings for better performance. But, here I want to focus more on function limitations of “one exchange” solutions.</p>

<p><strong>Solution 5</strong><br />
One case we might natually consider multiple exchanges is for different groups or dimensions of events. For instance, besides the created, updated and deleted events memtioned above, if we have another group of events: login and logout - a group of events describing “user behaviors” rather than “data write”. Coz different group of events might need completely different routing strategies and routing key &amp; queue naming conventions, it is so that natual to have a separate user.behavior exchange.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>| queue              | subscriber  |
|----------------------------------|
| user.write.app1    | app1        |
| user.created.app2  | app2        |
| user.behavior.app3 | app3        |

| exchange      | type  | binding_queue      | binding_key     |
|--------------------------------------------------------------|
| user.write    | topic | user.write.app1    | user.*          |
| user.write    | topic | user.created.app2  | user.created    |
| user.behavior | topic | user.behavior.app3 | user.*          |
</code></pre>
</div>

<p><strong>Other Solutions</strong><br />
There are other cases when we might need multiple exchanges for one object type. For instance, if you want to set different permissions on exchanges (e.g. only selected events of one object type are allowed to be published to one exchange from external apps, while the other exchange accepts any the events from internal apps). For another instance, if you want to use different exchanges suffixed with a version number to support different versions of routing strategies of same group of events. For another another instance, you might want to define some “internal exchanges” for exchange-to-exchange bindings, which could manage routing rules in a layered way.</p>

<p>In summary, still, “the final solution depends on your system needs”, but with all the solution examples above, and with the background considerations, as said in the <a href="http://spring.io/blog/2011/04/01/routing-topologies-for-performance-and-scalability-with-rabbitmq/">performance and scalability consideration link</a>, I also hope it could at least get one thinking in the right directions.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/02/22/understanding-rabbitmq-exchange-and-queue/">
        Understanding RabbitMQ Exchange and Queue
      </a>
    </h1>

    <span class="post-date">22 Feb 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/rabbitmq">rabbitmq</a>&nbsp;&nbsp;
	  
	
	</span>
    <p>In <a href="/2016/02/18/behind-rabbitmq-exchange-types/">previous post</a>, I compared the difference of ActiveMQ (JMS) and RabbitMQ (AMQP)’s design philosophy. RabbitMQ has its beauty of simplicity in its design with 5 exchange types. In this post, I want to clarify the understanding of RabbitMQ’s exchange &amp; queue and their relationship - binding.</p>

<p>In brief, exchanges are the only places where messages could be published to; while queues are the only places where messages could be consumed from. And the configurations for how messages should be routed from exchanges to queues are called bindings.</p>

<p>Imagine a message as a mail, then an exchange is like a post office, and a queue is kind of a mailbox in front of someone’s house. Different exchange types are like different types of mails which will be delivered in different ways. For instances, if a school wants to send the same notification mail to every student’s mailbox (kind of broardcast), it is exchange type - “fanout”; if a mail should only be sent to one specific student’s mailbox, it is exchange type - “direct”, and the key of the binding between the exchange and the queue should be the address of the student’s mailbox which the post office could understand. The mail to be sent to the post office should have the same address written on it, this address is the “routing key” of the message.</p>

<p>In RabbitMQ, it is not possible for a publisher to send a message to a queue directly. Even when you send a message without specifying an exchange, the message is actually sent to the global default exchange, who has bindings to each queue with queue name as binding key.</p>

<p>Messages can only be consumed from queues, consuming from exchanges directly are not allowed. An exchange has no storage. So if you send a message to an exchange while there are no queues bound to it or no bindings match the routing key of the message, the message will be thrown away immediately.</p>

<p>About designing exchanges, there is <a href="http://stackoverflow.com/questions/32220312/rabbitmq-amqp-best-practise-queue-topic-design-in-a-microservice-architecture">an interesting discussion</a> on StackOverflow for modeling a classic scenario. One exchange, or many? Which one is better? My opinion is similar to derick’s. It really depends on your system needs. RabbitMQ’s exchange types are simple, but flexible enough to support different modellings for the same scenario. There are always tradeoffs with each one. But no matter one or many exchanges you choose, I agree with Jason Lotito’s comments there about routing keys and naming convention of queues: “Routing keys are elements of the message, and the queues shouldn’t care about that (he means the naming of queues should not care about value of routing keys of published messages). That’s what bindings are for.”, “Queue names should be named after what the consumer attached to the queue will do. What is the intent of the operation of this queue.”.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/02/18/behind-rabbitmq-exchange-types/">
        Behind RabbitMQ Exchange Types
      </a>
    </h1>

    <span class="post-date">18 Feb 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/rabbitmq">rabbitmq</a>&nbsp;&nbsp;
	  
	
	</span>
    <p>Before touching RabbitMQ, I used MSMQ &amp; ZeroMQ much in real projects before. I also played  Apache ActiveMQ together with Camel a little bit (but not in real projects) when evaluating different ESB solutions before.</p>

<p>Like everyone, my first glance of RabbitMQ is the <a href="https://www.rabbitmq.com/getstarted.html">Get Started</a> tutorials, and the feeling of the RabbitMQ design philosophy is, it is quite like the design philosophy of ZeroMQ - simple &amp; consistent interface and super flexible configuration. Among all of the configuration options, the most interesting part is the “exchange types”. You might want to say that the concept of “exchange types” is from the <a href="https://www.rabbitmq.com/amqp-0-9-1-reference.html">AMQP</a> protocol, not invented by RabbitMQ. Yes, you are right. But no doubt that RabbitMQ is one of the most popular AMQP implementations.</p>

<p>The 6 examples in the <a href="https://www.rabbitmq.com/getstarted.html">Get Started</a> tutorials show the flexibility of RabbitMQ with the consistent and simple Publish &amp; Receive interface. And I believe you could already imagine many more usages of them to match many other common scenarios.</p>

<p>But, what’s the underlying philosophy behind “exchange types”? In a word, it is all about implementing integration patterns in a manner of simple, stupid.</p>

<p>If you ever played Apache ActiveMQ and Camel, you must be familar with the <a href="http://www.enterpriseintegrationpatterns.com">Enterprise Integration Patterns</a>. The examples of Apache Camel even exactly match all of the integration patterns. The design philosophy of ActiveMQ is, it provides the basic queue and pub/sub ability, and, together with Camel, to give ultimate flexibility for implementing all the integration patterns.</p>

<p>The design philosophy of ZeroMQ and RabbitMQ is quite different. Ultimate flexibility is cool, but performance and simplicity are also important. ZeroMQ chooses ultimate performance and simplicity rather than more integration features, while RabbitMQ is kind of in between of ActiveMQ and ZeroMQ. Its interface is as simple as ZeroMQ; the performance is not as super as ZeroMQ, but good enough; and it provides minimal but elegant configuration options to support most of the common integration patterns. One of the essences of its design is just the “exchange types”, which abstracts most common message routing &amp; consuming scenarios with only 5 easy-to-understand types: default (no routing), direct, fanout (broadcast), topic and header.</p>

<p>Modeling &amp; programming is the art of abstracting complexity. A real elegant design must be simple, stupid! That’s what behind the idea of “exchange types”.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2016/01/21/integrate-prettyphoto-with-jekyll-picture-tag/">
        Integrate PrettyPhoto with jekyll-picture-tag plugin
      </a>
    </h1>

    <span class="post-date">21 Jan 2016&nbsp;&nbsp;&nbsp;&nbsp;
	
	  
	    <a href="/tag/jekyll">jekyll</a>&nbsp;&nbsp;
	  
	
	</span>
    <p>In <a href="/2016/01/20/installed-jekyll-picture-tag/">previous post</a>, I talked about installed jekyll-picture-tag plugin to display pictures responsively in posts. It works very well in different browsers and resolutions. But sometimes, we might want a photo gallery. Instead of displaying the full size of photos, we might want to display thumbnails, and on click, popup a lightbox style slideshow window for displaying the full size of photos.</p>

<p>So, in this post, I want to talk about how I have integrated <a href="http://www.no-margin-for-errors.com/projects/prettyphoto-jquery-lightbox-clone/#prettyPhoto">PrettyPhoto</a> with jekyll-picture-tag plugin. Our goal is no change to jekyll-picture-tag plugin, and to use the same jekyll-picture-tag’s liquid tag format, only to add PrettyPhoto effect with addtional attributes when necessary.</p>

<p>The live example, is already in the <a href="/2016/01/20/installed-jekyll-picture-tag/">previous post</a>, an image is clicked, the PrettyPhoto slideshow window will popup.</p>

<p>The only addtional attribute we add to the jekyll-picture-tag liquid tag is “group”. You could see the sample liquid tag below. Images marked with the same group value, will be displayed together in the same PrettyPhoto slideshow window. So easy!</p>

<div class="highlighter-rouge"><pre class="highlight"><code>{% picture 2015-1-20-1.jpg alt="picture 1" group="1" %}
{% picture 2015-1-20-2.jpg alt="picture 2" group="1" %}
</code></pre>
</div>

<p>Besides the addtional attribute in liquid tag. We also need to add necessary css and js to our page template. So, in the header include file, we need to add the following:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>  <span class="c">&lt;!-- Pretty Photo --&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/public/js/jquery-1.6.1.min.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;&lt;/script&gt;</span>
  <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/public/css/prettyPhoto.css"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="na">media=</span><span class="s">"screen"</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/public/js/jquery.prettyPhoto.js"</span> <span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;&lt;/script&gt;</span>  
  <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
	  <span class="nx">$</span><span class="p">(</span><span class="s2">"picture img"</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'group'</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
		
	    <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">parent</span><span class="p">();</span>
	    <span class="nx">parent</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'rel'</span><span class="p">,</span> <span class="s1">'prettyPhoto[group_'</span> <span class="o">+</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'group'</span><span class="p">)</span> <span class="o">+</span> <span class="s1">']'</span><span class="p">);</span>
		<span class="nx">parent</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'href'</span><span class="p">,</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">first</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'srcset'</span><span class="p">));</span>
	  <span class="p">});</span>
      <span class="nx">$</span><span class="p">(</span><span class="s2">"picture[rel^='prettyPhoto']"</span><span class="p">).</span><span class="nx">prettyPhoto</span><span class="p">({</span><span class="na">theme</span><span class="p">:</span><span class="s1">'pp_default'</span><span class="p">,</span><span class="na">slideshow</span><span class="p">:</span><span class="mi">5000</span><span class="p">,</span><span class="na">autoplay_slideshow</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="na">social_tools</span><span class="p">:</span><span class="kc">false</span><span class="p">});</span>
    <span class="p">});</span>
  <span class="nt">&lt;/script&gt;</span>  
</code></pre>
</div>

<p>Also, we need to add necessary css, js and image files to the jekyll repo. All the files could be downloaded from the official <a href="http://www.no-margin-for-errors.com/projects/prettyphoto-jquery-lightbox-clone/#prettyPhoto">PrettyPhoto</a> site.</p>


  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page2">Older</a>
  
  
    <span class="pagination-item newer">Newer</span>
  
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
